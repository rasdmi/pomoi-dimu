<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>–ü–æ–º–æ–π –î–∏–º—É</title>
<style>
  html,body{height:100%;margin:0}
  body{background:#eff1f3;font-family:system-ui,Segoe UI,Roboto,Manrope,sans-serif}
  #wrap{display:flex;align-items:center;justify-content:center;height:100%}
  canvas{background:#f6e7ef;box-shadow:0 8px 30px rgba(0,0,0,.15);border-radius:14px;max-width:100%;height:auto;touch-action:none}
  .hud{position:fixed;left:10px;top:10px;background:rgba(255,255,255,.92);padding:6px 10px;border-radius:10px;font-weight:800;z-index:2}
  .tools{position:fixed;left:50%;transform:translateX(-50%);top:8px;display:flex;gap:8px;z-index:3}
  .tool{padding:8px 12px;border-radius:12px;border:2px solid #d6dbe3;background:#fff;font-size:18px;font-weight:800;cursor:pointer;box-shadow:0 3px 10px rgba(0,0,0,.08)}
  .tool.active{border-color:#ff6b35;background:#ffe6dc}
  .summary{position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;padding:20px;z-index:4}
  .summary .card{background:#fff;border-radius:16px;box-shadow:0 20px 80px rgba(0,0,0,.25);max-width:560px;width:100%;padding:22px}
  .summary h2{margin:0 0 8px 0}
  .btn{padding:10px 18px;font-size:16px;font-weight:700;border:none;border-radius:10px;cursor:pointer;background:#ff6b35;color:#fff;box-shadow:0 4px 10px rgba(0,0,0,.2)}
  .hidden{display:none}
</style>
</head>
<body>
<div class="hud">–ß–∏—Å—Ç–æ—Ç–∞: <span id="clean">0%</span></div>
<div class="tools">
  <button id="tHose" class="tool active">üöø –®–ª–∞–Ω–≥</button>
  <button id="tSponge" class="tool">üßΩ –ú–æ—á–∞–ª–∫–∞</button>
  <button id="restart" class="tool" title="–°–±—Ä–æ—Å–∏—Ç—å –∏ —Å–Ω–æ–≤–∞ –∑–∞–ø–∞—á–∫–∞—Ç—å">üîÑ –ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
</div>
<div id="wrap"><canvas id="game" width="1024" height="576"></canvas></div>

<div id="summary" class="summary hidden" role="dialog" aria-modal="true">
  <div class="card">
    <h2>–£—Ä–∞! –î–∏–º–∞ —á–∏—Å—Ç—ã–π!</h2>
    <p id="sumText"></p>
    <div style="text-align:center;margin-top:14px">
      <button id="again" class="btn">üîÑ –ï—â—ë —Ä–∞–∑</button>
    </div>
  </div>
</div>

<script>
(() => {
  const c = document.getElementById('game');
  const ctx = c.getContext('2d');
  const cleanEl = document.getElementById('clean');
  const summary = document.getElementById('summary');
  const sumText = document.getElementById('sumText');
  const againBtn = document.getElementById('again');

  const btnHose   = document.getElementById('tHose');
  const btnSponge = document.getElementById('tSponge');
  const btnRestart= document.getElementById('restart');

  // ------ –ò–ù–°–¢–†–£–ú–ï–ù–¢–´ ------
  let tool = 'hose';          // 'hose' | 'sponge'
  let using = false;          // —É–¥–µ—Ä–∂–∏–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
  let pointer = {x: c.width/2, y: c.height/2, px: c.width/2, py: c.height/2};

  btnHose.onclick = ()=>{ tool='hose'; setActive(); };
  btnSponge.onclick = ()=>{ tool='sponge'; setActive(); };
  function setActive(){
    btnHose.classList.toggle('active', tool==='hose');
    btnSponge.classList.toggle('active', tool==='sponge');
  }

  // ------ –°–¶–ï–ù–ê ------
  const GROUND_Y = 480;

  // ¬´—Ä–æ–∑–æ–≤—ã–µ –ø–ª–∏—Ç–∫–∏¬ª —Å —Ä–æ–∑–∞–º–∏ üåπ
  const tiles = [];
  function makeTiles(){
    tiles.length = 0;
    const size = 64;
    for (let y = 0; y < c.height; y += size){
      for (let x = 0; x < c.width; x += size){
        tiles.push({x,y,w:size,h:size,rose: Math.random() < 0.25});
      }
    }
  }

  // –≤–∞–Ω–Ω–∞ –∏ –î–∏–º–∞
  const tub = {x: c.width/2 - 260, y: 360, w: 520, h: 150};
  const dima = {x: c.width/2, headR: 34, bodyW: 120, bodyH: 110};

  // –≥—Ä—è–∑—å
  const spots = []; // {x,y,r,life,color}
  const palette = ['#5a4126','#6b4f2a','#7b6036','#3e3b2b','#4b5d2b','#6a6d37','#3d2f24'];
  let totalInitial = 0;

  function isInDima(x,y){
    // –≥–æ–ª–æ–≤–∞ (–∫—Ä—É–≥) –∏–ª–∏ –≤–µ—Ä—Ö –∫–æ—Ä–ø—É—Å–∞ (–æ–≤–∞–ª)
    const hx=dima.x, hy=tub.y-80;
    const inHead = ((x-hx)**2 + (y-hy)**2) <= (dima.headR*1.02)**2;
    const bx=dima.x, by=tub.y-30, rx=dima.bodyW*0.5, ry=dima.bodyH*0.5;
    const inBody = (((x-bx)/rx)**2 + ((y-by)/ry)**2) <= 1;
    return inHead || inBody;
  }

  function spawnSpots(n=40){
    for(let i=0;i<n;i++){
      let x,y,tries=0;
      do{
        x = tub.x + 40 + Math.random()*(tub.w-80);
        y = tub.y - 120 + Math.random()*150;
        tries++;
      }while(!isInDima(x,y) && tries<50);
      const r = 8 + Math.random()*18;
      spots.push({x,y,r,life:r, color: palette[(Math.random()*palette.length)|0]});
    }
    totalInitial = spots.length;
  }

  // –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ ¬´–∑–∞–ø–∞—á–∫–∏–≤–∞–Ω–∏–µ¬ª
  let dirtyTimer = 0;
  function randomDirty(dt){
    dirtyTimer -= dt;
    if(dirtyTimer<=0){
      const add = 3 + (Math.random()*5|0);
      spawnSpots(add);
      dirtyTimer = 3500 + Math.random()*2500; // –∫–∞–∂–¥—ã–µ 3.5‚Äì6—Å
    }
  }

  // ------ –ß–ò–°–¢–ö–ê ------
  function cleanAt(x,y,dt){
    // —Ä–∞–¥–∏—É—Å –∏ —Å–∏–ª–∞ –∑–∞–≤–∏—Å—è—Ç –æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
    let R = (tool==='hose')? 44 : 26;
    let power = (tool==='hose')? 0.45 : 1.2; // –∑–∞ –∫–∞–¥—Ä
    let cleaned=0;

    for(let i=spots.length-1;i>=0;i--){
      const s = spots[i];
      const d = Math.hypot(s.x-x, s.y-y);
      if (d < R + s.r*0.6){
        s.life -= power * (dt/16.67);
        s.r = Math.max(0, s.life);
        if (s.r<=1){ spots.splice(i,1); cleaned++; }
      }
    }
    return cleaned;
  }

  // —á–∞—Å—Ç–∏—á–∫–∏ –≤–æ–¥—ã/–ø–µ–Ω—ã
  const particles=[];
  function spray(x,y,dt){
    const n = (tool==='hose')? 12 : 8;
    for(let i=0;i<n;i++){
      const ang = (tool==='hose')? (Math.random()*Math.PI*0.6 - Math.PI*0.3) : Math.random()*Math.PI*2;
      const sp  = (tool==='hose')? (2+Math.random()*3) : (1+Math.random()*2);
      particles.push({
        x, y, vx: Math.cos(ang)*sp*(tool==='hose'?1.6:0.8), vy: (tool==='hose'?2.2:0.6)+Math.sin(ang)*sp,
        life: (tool==='hose'? 400: 450), foam: tool==='sponge'
      });
    }
  }

  // ------ –í–í–û–î ------
  c.addEventListener('pointerdown', e=>{ using=true; setPointer(e); c.setPointerCapture(e.pointerId); });
  c.addEventListener('pointerup',   e=>{ using=false; c.releasePointerCapture(e.pointerId); });
  c.addEventListener('pointermove', e=>{ setPointer(e); });
  function setPointer(e){
    const rect = c.getBoundingClientRect();
    pointer.px = pointer.x; pointer.py = pointer.y;
    pointer.x = (e.clientX - rect.left) * (c.width/rect.width);
    pointer.y = (e.clientY - rect.top)  * (c.height/rect.height);
  }

  btnRestart.onclick = restart;
  againBtn.onclick   = restart;

  // ------ –ö–ê–ú–ï–†–ê (—Å—Ç–∞—Ç–∏—á–Ω–∞—è), –û–¢–†–ò–°–û–í–ö–ê ------
  function drawBackground(){
    // –ø–ª–∏—Ç–∫–∏
    for(const t of tiles){
      ctx.fillStyle = '#fde9f0';
      ctx.fillRect(t.x,t.y,t.w,t.h);
      ctx.strokeStyle = '#f4c8d7';
      ctx.lineWidth = 2;
      ctx.strokeRect(t.x+0.5,t.y+0.5,t.w-1,t.h-1);
      if(t.rose){
        ctx.font='22px Apple Color Emoji, Segoe UI Emoji, Noto Color Emoji';
        ctx.textAlign='center'; ctx.textBaseline='middle';
        ctx.fillText('üåπ', t.x+t.w/2, t.y+t.h/2);
      }
    }
  }

  function drawTubAndDima(now){
    // –≤–∞–Ω–Ω–∞ (—Ä–æ–∑–æ–≤–∞—è)
    ctx.fillStyle='#ffb6cf'; // —Ç–µ–ª–æ –≤–∞–Ω–Ω—ã
    ctx.fillRect(tub.x, tub.y, tub.w, tub.h);
    // –∫—Ä–∞–π
    ctx.fillStyle='#ffc3d7';
    ctx.fillRect(tub.x-8, tub.y-14, tub.w+16, 20);
    // –≤–æ–¥–∞ –ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è
    ctx.fillStyle='rgba(173,216,230,0.35)';
    ctx.fillRect(tub.x, tub.y+36, tub.w, 20);

    // –î–∏–º–∞ ‚Äî —Ç—É–ª–æ–≤–∏—â–µ –∏ —Ä—É–∫–∏
    const hx=dima.x, hy=tub.y-80;
    ctx.fillStyle='#ffe1c2';
    ctx.beginPath(); ctx.ellipse(dima.x, tub.y-30, dima.bodyW/2, dima.bodyH/2, 0, 0, Math.PI*2); ctx.fill();
    // —Ä—É–∫–∏
    ctx.beginPath(); ctx.ellipse(dima.x-60, tub.y-30, 16, 10, 0, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(dima.x+60, tub.y-30, 16, 10, 0, 0, Math.PI*2); ctx.fill();

    // –≥–æ–ª–æ–≤–∞
    ctx.beginPath(); ctx.arc(hx, hy, dima.headR, 0, Math.PI*2); ctx.fill();
    // –ª–∏—Ü–æ
    ctx.fillStyle='#333';
    ctx.beginPath(); ctx.arc(hx-10, hy-6, 3, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(hx+10, hy-6, 3, 0, Math.PI*2); ctx.fill();
    ctx.strokeStyle='#333'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.arc(hx, hy+8, 10, 0, Math.PI); ctx.stroke();

    // –ø–µ–Ω–∞ –Ω–∞ –∫—Ä–∞—è—Ö –≤–æ–¥—ã ¬´–¥–ª—è –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã¬ª
    ctx.fillStyle='rgba(255,255,255,.8)';
    for(let i=0;i<10;i++){
      const x=tub.x+30+i*(tub.w-60)/9, y=tub.y+36;
      ctx.beginPath(); ctx.ellipse(x, y, 14, 8, 0, 0, Math.PI*2); ctx.fill();
    }
  }

  function drawSpots(){
    for(const s of spots){
      ctx.fillStyle=s.color;
      ctx.beginPath(); ctx.ellipse(s.x, s.y, s.r, s.r*0.7, Math.random()*0.5, 0, Math.PI*2);
      ctx.fill();
    }
  }

  function drawToolAndFx(now){
    // —á–∞—Å—Ç–∏—Ü—ã –≤–æ–¥—ã/–ø–µ–Ω—ã
    for(let i=particles.length-1;i>=0;i--){
      const p=particles[i]; p.life-=16; p.x+=p.vx; p.y+=p.vy; p.vy += p.foam? -0.01 : 0.12;
      if(p.life<=0) particles.splice(i,1);
      else{
        ctx.globalAlpha = Math.max(0, Math.min(1, p.life/450));
        ctx.fillStyle = p.foam? 'rgba(255,255,255,.9)' : 'rgba(80,160,255,.9)';
        ctx.beginPath(); ctx.arc(p.x, p.y, p.foam? 3.8:2.6, 0, Math.PI*2); ctx.fill();
        ctx.globalAlpha = 1;
      }
    }

    // –∫—É—Ä—Å–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
    ctx.save();
    ctx.translate(pointer.x, pointer.y);
    if(tool==='hose'){
      // —Ä—É–∫–æ—è—Ç–∫–∞
      ctx.fillStyle='#7aa0ff';
      ctx.fillRect(-8,-8,16,40);
      ctx.fillStyle='#4678ff';
      ctx.fillRect(-12,22,24,6);
      // —Å—Ç—Ä—É—è –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏
      if(using){
        ctx.strokeStyle='rgba(80,160,255,.7)';
        ctx.lineWidth=4; ctx.beginPath();
        ctx.moveTo(0,25); ctx.lineTo(0,60); ctx.stroke();
      }
    } else {
      // –º–æ—á–∞–ª–∫–∞
      ctx.fillStyle='#ffd66b';
      ctx.beginPath(); ctx.ellipse(0,0,26,18, 0, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle='#ffb84d';
      ctx.beginPath(); ctx.ellipse(4,4,18,12, 0, 0, Math.PI*2); ctx.fill();
      if(using){
        // –Ω–µ–º–Ω–æ–≥–æ –ø–µ–Ω—ã –ø–æ–¥ –º–æ—á–∞–ª–∫–æ–π
        for(let i=0;i<4;i++){
          ctx.fillStyle='rgba(255,255,255,.85)';
          ctx.beginPath(); ctx.arc(-16+i*10, 16, 6, 0, Math.PI*2); ctx.fill();
        }
      }
    }
    ctx.restore();
  }

  // ------ –õ–û–ì–ò–ö–ê ¬´–ß–ò–°–¢–û–¢–´¬ª ------
  function updateCleanPercent(){
    // —Å—á–∏—Ç–∞–µ–º –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Ç–æ—á–µ–∫ –∏ –∏—Ö –æ—Å—Ç–∞—Ç–æ—á–Ω–æ–π ¬´–∂–∏–∑–Ω–∏¬ª
    const total = totalInitial || 1;
    let left=0;
    for(const s of spots) left += s.r;
    // –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ –Ω–æ—Ä–º–∏—Ä—É–µ–º
    const cur = Math.max(0, Math.min(100, Math.round(100 - (left/(total*16))*100)));
    cleanEl.textContent = cur + '%';
    if (cur>=100 && spots.length===0){
      summary.classList.remove('hidden');
      sumText.textContent = '–¢—ã –æ—Ç–º—ã–ª –î–∏–º—É –Ω–∞ 100%! –ù–æ –æ–Ω –º–æ–∂–µ—Ç —Å–Ω–æ–≤–∞ –∏—Å–ø–∞—á–∫–∞—Ç—å—Å—è üôÇ';
    }
  }

  // ------ –¶–ò–ö–õ ------
  let last = performance.now();
  function loop(t){
    const dt = Math.min(33, t-last); last=t;

    // —Ä–µ–≥—É–ª—è—Ä–Ω–æ –ø–æ–¥–±—Ä–∞—Å—ã–≤–∞–µ–º –≥—Ä—è–∑—å
    randomDirty(dt);

    // —á–∏—Å—Ç–∏–º –≤ –º–µ—Å—Ç–µ –∫—É—Ä—Å–æ—Ä–∞, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
    if(using){
      const cx = pointer.x, cy = pointer.y;
      cleanAt(cx, cy, dt);
      spray(cx, cy, dt);
    }

    // –†–ï–ù–î–ï–†
    ctx.clearRect(0,0,c.width,c.height);
    drawBackground();
    drawTubAndDima(t);
    drawSpots();
    drawToolAndFx(t);
    updateCleanPercent();

    requestAnimationFrame(loop);
  }

  // ------ –°–¢–ê–†–¢/–†–ï–°–¢–ê–†–¢ ------
  function restart(){
    summary.classList.add('hidden');
    makeTiles();
    spots.length=0; particles.length=0; totalInitial=0;
    spawnSpots(38);
    dirtyTimer = 2500;
  }

  makeTiles();
  restart();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
